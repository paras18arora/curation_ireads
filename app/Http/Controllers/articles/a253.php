<link rel='stylesheet' href='digital_ocean.css'><br><img src=https://community-cdn-digitalocean-com.global.ssl.fastly.net/assets/tutorials/images/large/SSL-Term-HAProxy-Ubuntu-Twitter.png?1426699701/> <br> 
      <h3 id="introduction">Introduction</h3>

<p>HAProxy, which stands for High Availability Proxy, is a popular open source software TCP/HTTP Load Balancer and proxying solution which can be run on Linux, Solaris, and FreeBSD. Its most common use is to improve the performance and reliability of a server environment by distributing the workload across multiple servers (e.g. web, application, database). It is used in many high-profile environments, including: GitHub, Imgur, Instagram, and Twitter.</p>

<p>In this tutorial, we will go over how to use HAProxy for SSL termination, for traffic encryption, and for load balancing your web servers. We will also show you how to use HAProxy to redirect HTTP traffic to HTTPS. </p>

<p>Native SSL support was implemented in HAProxy 1.5.x, which was released as a stable version in June 2014.</p>

<h2 id="prerequisites">Prerequisites</h2>

<p>To complete this tutorial, you must have or obtain the following:</p>

<ul>
<li>At least one web server, with private networking, listening on HTTP (port 80)</li>
<li>Root access to an additional VPS on which we will install HAProxy. Instructions to set up root access can be found here (steps 3 and 4): <a href="https://indiareads/community/tutorials/initial-server-setup-with-ubuntu-14-04">Initial Server Setup with Ubuntu 14.04</a>.</li>
<li>An SSL certificate and private key pair with a "common name" that matches your domain name or IP address</li>
</ul>

<p>If you do not already have an SSL certificate and private key pair, please obtain one before continuing. Here are a few tutorials that contain steps that cover creating SSL certificates:</p>

<ul>
<li><a href="https://indiareads/community/tutorials/how-to-set-up-apache-with-a-free-signed-ssl-certificate-on-a-vps">Create an StartSSL Certificate (<em>private.key</em> and <em>ssl.crt</em>)</a></li>
<li><a href="https://indiareads/community/tutorials/how-to-create-a-ssl-certificate-on-apache-for-ubuntu-14-04#StepTwo%E2%80%94CreateaSelf-SignedSSLCertificate">Create a Self-Signed SSL Certificate on Ubuntu 14.04 (Step 2--<em>apache.key</em> and <em>apache.crt</em>)</a></li>
</ul>

<h3 id="creating-a-combined-pem-ssl-certificate-key-file">Creating a Combined PEM SSL Certificate/Key File</h3>

<p>To implement SSL termination with HAProxy, we must ensure that your SSL certificate and key pair is in the proper format, PEM. In most cases, you can simply combine your SSL certificate (.crt or .cer file provided by a certificate authority) and its respective private key (.key file, generated by you). Assuming your certificate file is called <code>example.com.crt</code>, and your private key file is called <code>example.com.key</code>, here is an example of how to combine the files:</p>
<pre class="code-pre "><code langs="">cat <span class="highlight">example.com</span>.crt <span class="highlight">example.com</span>.key > example.com.pem
sudo cp <span class="highlight">example.com</span>.pem /etc/ssl/private/
</code></pre>
<p>This creates the combined PEM file, called <code>example.com.pem</code>  and copies it to <code>/etc/ssl/private</code>. As always, be sure to secure any copies of your private key file, including the PEM file (which contains the private key).</p>

<p>In some cases, you may need to copy your CA root certificate and CA intermediate certificates into your PEM file.</p>

<h2 id="our-starting-environment">Our Starting Environment</h2>

<p>Here is the environment that we are starting with:</p>

<p><img src="https://assets.digitalocean.com/articles/HAProxy/ssl/web_server_http.png" alt="Web Server on HTTP" /></p>

<p>If your environment differs from the example, like if you are already using SSL on the web server or you have a separate database server, you should be able to adapt this tutorial to work with your environment.</p>

<p>If you are unfamiliar with basic load-balancing concepts or terminology, like layer 7 load balancing or backends or ACLs, here is an article that explains the basics: <a href="https://indiareads/community/articles/an-introduction-to-haproxy-and-load-balancing-concepts">An Introduction to HAProxy and Load Balancing Concepts</a>.</p>

<h2 id="our-goal">Our Goal</h2>

<p>By the end of this tutorial, we want to have an environment that looks like this:</p>

<p><img src="https://assets.digitalocean.com/articles/HAProxy/ssl/haproxy_ssl.png" alt="HAProxy SSL Termination" /></p>

<p>That is, your users will access your website by connecting to your HAProxy server via HTTPS, which will decrypt the SSL session and forward the unencrypted requests to your web servers (i.e. the servers in www-backend) via their private network interfaces on port 80. Your web servers will then send their responses to your HAProxy server, which will encrypt the responses and send them back to the user that made the original request.</p>

<p>You can set up your <em>www-backend</em> with as many web servers as you want, as long as they serve identical content. In other words, you can set this up with a single server then scale it out later by adding as many servers as you want. Remember, as your traffic increases, your HAProxy server may become a performance bottleneck if it does not have enough system resources to handle your user traffic.</p>

<p><strong>Note:</strong> This tutorial does not cover how to ensure that your web/application servers serve the same content because that is often application or web server dependent.</p>

<h2 id="install-haproxy-1-6-x">Install HAProxy 1.6.x</h2>

<p>Create a new VPS with private networking. For this tutorial, we will call it <em>haproxy-www</em>, but you may call it whatever you want.</p>

<p>In our <strong>haproxy-www</strong> VPS, add the dedicated PPA to apt-get:</p>
<pre class="code-pre "><code langs="">sudo add-apt-repository ppa:vbernat/haproxy-1.6
</code></pre>
<p>Then update your apt cache:</p>
<pre class="code-pre "><code langs="">sudo apt-get update
</code></pre>
<p>Then install HAProxy 1.6 with apt-get with the following command:</p>
<pre class="code-pre "><code langs="">sudo apt-get install haproxy
</code></pre>
<p>Now that HAProxy 1.6 is installed, let's configure it!</p>

<h2 id="haproxy-configuration">HAProxy Configuration</h2>

<p>HAProxy's configuration file is located at <code>/etc/haproxy/haproxy.cfg</code> and is divided into two major sections:</p>

<ul>
<li><strong>Global</strong>: sets process-wide parameters</li>
<li><strong>Proxies</strong>: consists of <em>defaults</em>, <em>listen</em>, <em>frontend</em>, and <em>backend</em> sections</li>
</ul>

<p>Again, if you are unfamiliar with HAProxy or basic load-balancing concepts and terminology, please refer to this link: <a href="https://indiareads/community/articles/an-introduction-to-haproxy-and-load-balancing-concepts">An Introduction to HAProxy and Load Balancing Concepts</a>.</p>

<h2 id="haproxy-configuration-global">HAProxy Configuration: Global</h2>

<p><strong>All of the HAProxy configuration should be done on your HAProxy VPS, <em>haproxy-www</em>.</strong></p>

<p>Open haproxy.cfg in an editor:</p>
<pre class="code-pre "><code langs="">sudo vi /etc/haproxy/haproxy.cfg
</code></pre>
<p>You will see that there are two sections already defined: <em>global</em> and <em>defaults</em>.</p>

<p>The first thing you will want to do is set <em>maxconn</em> to a reasonable number. This setting affects how many concurrent connections HAProxy will allow, which can affect QoS and prevent your web servers from crashing from trying to serve too many requests. You will need to play around with it to find what works for your environment. Add the following line (with a value you think is reasonable) to the <em>global</em> section of the configuration</p>
<pre class="code-pre "><code langs="">   maxconn <span class="highlight">2048</span>
</code></pre>
<p>Add this line, to configure the maximum size of temporary DHE keys that are generated:</p>
<pre class="code-pre "><code langs="">   tune.ssl.default-dh-param 2048
</code></pre>
<p>Next, in the <em>defaults</em> section, add the following lines under the line that says <code>mode http</code>:</p>
<pre class="code-pre "><code langs="">   option forwardfor
   option http-server-close
</code></pre>
<p>The <em>forwardfor</em> option sets HAProxy to add X-Forwarded-For headers to each request, and the <em>http-server-close</em> option reduces latency between HAProxy and your users by closing connections but maintaining keep-alives.</p>

<h3 id="haproxy-configuration-stats">HAProxy Configuration: Stats</h3>

<p>Using HAProxy stats can be useful in determining how HAProxy is handling incoming traffic. If you would like to enable the HAProxy stats page, add the following lines in the <em>defaults</em> section (substitute user and password with secure values):</p>
<pre class="code-pre "><code langs="">   stats enable
   stats uri <span class="highlight">/stats</span>
   stats realm Haproxy\ Statistics
   stats auth <span class="highlight">user</span>:<span class="highlight">password</span>
</code></pre>
<p>This will allow you to look at the HAProxy stats page by going to your domain on <code>/stats</code> (e.g. https://example.com/stats).</p>

<p>Do not close the config file yet! We will add the proxy configuration next.</p>

<h2 id="haproxy-configuration-proxies">HAProxy Configuration: Proxies</h2>

<h3 id="frontend-configuration">Frontend Configuration</h3>

<p>The first thing we want to add is a frontend to handle incoming HTTP connections. At the end of the file, let's add a frontend called <em>www-http</em>. Be sure to replace <code>haproxy_www_public_IP</code> with the <strong>public IP</strong> of your haproxy-www VPS:</p>
<pre class="code-pre "><code langs="">frontend www-http
   bind <span class="highlight">haproxy_www_public_IP</span>:80
   reqadd X-Forwarded-Proto:\ http
   default_backend www-backend
</code></pre>
<p>Here is an explanation of what each line in the frontend config snippet above means:</p>

<ul>
<li><strong>frontend www-http</strong>: specifies a frontend named "www-http"</li>
<li><strong>bind haproxy_www_public_IP:80</strong>: replace <code>haproxy_www_public_IP</code> with haproxy-www's public IP address. This tells HAProxy that this frontend will handle the incoming network traffic on this IP address and port 80 (HTTP)</li>
<li><strong>reqadd X-Forwarded-Proto:\ http</strong>: Adds http header to end of end of the HTTP request</li>
<li><strong>default_backend www-backend</strong>: this specifies that any traffic that this frontend receives will be forwarded to <em>www-backend</em>, which we will define in a following step</li>
</ul>

<p>Next, we will add a frontend to handle incoming HTTPS connections. At the end of the file, let's add a frontend called <em>www-https</em>. Be sure to replace <code>haproxy_www_public_IP</code> with the <strong>public IP</strong> of your haproxy-www VPS:</p>
<pre class="code-pre "><code langs="">frontend www-https
   bind <span class="highlight">haproxy_www_public_IP</span>:443 ssl crt /etc/ssl/private/<span class="highlight">example.com.pem</span>
   reqadd X-Forwarded-Proto:\ https
   default_backend www-backend
</code></pre>
<ul>
<li><strong>frontend www-https</strong>: specifies a frontend named "www-https"</li>
<li><strong>bind haproxy_www_public_IP:443 ssl crt ...</strong>: replace <code>haproxy_www_public_IP</code> with haproxy-www's public IP address, and <code>example.com.pem</code> with your SSL certificate and key pair in combined <em>pem</em> format. This tells HAProxy that this frontend will handle the incoming network traffic on this IP address and port 443 (HTTPS).</li>
<li><strong>reqadd X-Forwarded-Proto:\ https</strong>: Adds https header to end of end of the HTTPS request</li>
<li><strong>default_backend www-backend</strong>: this specifies that any traffic that this frontend receives will be forwarded to <em>www-backend</em>, which we will define in a following step</li>
</ul>

<h3 id="backend-configuration">Backend Configuration</h3>

<p>After you are finished configuring the frontends, continue adding your backend by adding the following lines. Be sure to replace the highlighted words with the respective private IP addresses of your web servers:</p>
<pre class="code-pre "><code langs="">backend www-backend
   redirect scheme https if !{ ssl_fc }
   server www-1 <span class="highlight">www_1_private_IP</span>:80 check
   server www-2 <span class="highlight">www_2_private_IP</span>:80 check
</code></pre>
<p>Here is an explanation of what each line in the backend config snippet above means:</p>

<ul>
<li><strong>backend www-backend</strong>: specifies a backend named <em>www-backend</em></li>
<li><strong>redirect scheme https if !{ ssl_fc }</strong>: this line redirects HTTP requests to HTTPS, which makes your site HTTPS-only. If you want to allow both HTTP and HTTPS, remove this line</li>
<li><strong>server www-1 ...</strong>: specifies a backend server named <em>www-1</em>, the private IP (which you must substitute) and port that it is listening on, <em>80</em>. The <em>check</em> option makes the load balancer periodically perform a health check on this server</li>
<li><strong>server www-2 ...</strong>: similar to the previous line. Add additional lines like this, with appropriate names and IP addresses to add more servers to the load balancer</li>
</ul>

<p>Now save and exit <code>haproxy.cfg</code>. HAProxy is now ready to be started, but let's enable logging first.</p>

<h2 id="enable-haproxy-logging">Enable HAProxy Logging</h2>

<p>Enabling logging in HAProxy is very simple. First edit the rsyslog.conf file:</p>
<pre class="code-pre "><code langs="">sudo vi /etc/rsyslog.conf
</code></pre>
<p>Then find the following two lines, and uncomment them to enable UDP syslog reception. It should look like the following when you are done:</p>
<pre class="code-pre "><code langs="">$ModLoad imudp
$UDPServerRun 514
$UDPServerAddress 127.0.0.1
</code></pre>
<p>Now restart rsyslog to enable the new configuration:</p>
<pre class="code-pre "><code langs="">sudo service rsyslog restart
</code></pre>
<p>HAProxy logging is is now enabled! The log file will be created at <code>/var/log/haproxy.log</code> once HAProxy is started.</p>

<h2 id="start-haproxy">Start HAProxy</h2>

<p><strong>On haproxy-www</strong>, start HAProxy to put your configuration changes into effect:</p>
<pre class="code-pre "><code langs="">sudo service haproxy restart
</code></pre>
<p>HAProxy is now performing SSL termination and load balancing your web servers! Your load balanced server is now accessible to your user via the public IP address or domain name of your load balancer, haproxy-www! There are a few things that you will want to check, to make sure everything is set up correctly.</p>

<h3 id="things-to-check">Things to Check</h3>

<ul>
<li>If you haven't already, update your nameservers to point your domain to your <em>haproxy-www</em> server's public IP address</li>
<li>If you want your servers to use only HTTPS, you will want to make sure that your web servers (e.g. www-1, www-2, etc.) are only listening on their private IP addresses on port 80. Otherwise, users will be able to access your web servers via HTTP (unencrypted) on their public IP addresses.</li>
<li>Visit <em>haproxy-www</em> via HTTPS and ensure that it works</li>
<li>Visit <em>haproxy-www</em> via HTTP and ensure that it redirects to HTTPS (unless you configured it to allow both HTTP and HTTPS)</li>
</ul>

<p><strong>Note:</strong> If you're using an application that needs to know its own URL, like WordPress, you need to change your URL setting from "http" to https". To follow the WordPress example, you would go to your WordPress General Settings, then change the WordPress Address (URL) and the Site Address (URL) from "http" to "https".</p>

<h2 id="conclusion">Conclusion</h2>

<p>Now you have a load balancer solution that handles your SSL connections and can be used to horizontally scale out your server environment. Feel free to combine what you have learned in this guide with other HAProxy guides to improve your environment even further!</p>

    